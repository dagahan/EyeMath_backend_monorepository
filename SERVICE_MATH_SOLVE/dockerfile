# Dockerfile для service_math_solve
FROM python:3.12-slim

# Установка системных зависимостей
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
      build-essential \
      protobuf-compiler \
      gcc \
      git \
      curl \
      ca-certificates && \
    rm -rf /var/lib/apt/lists/*

# Создание пользователя и группы
RUN useradd -m appuser && \
    mkdir -p /app/gen && \
    chown -R appuser:appuser /app

# Установка UV напрямую через pip
RUN pip install --no-cache-dir uv

# Клонирование .proto файлов
RUN git clone --depth=1 https://github.com/dagahan/EyeMath_protos.git /protos

# Генерация Python стабов
RUN pip install --no-cache-dir grpcio-tools grpcio-reflection && \
    find /protos -type f -name '*.proto' -exec python -m grpc_tools.protoc \
      -I /protos \
      --python_out=/app/gen \
      --grpc_python_out=/app/gen \
      --pyi_out=/app/gen \
      {} \;

# Копирование исходного кода
COPY . /app
WORKDIR /app

# Настройка окружения
ENV PATH="/usr/local/bin:$PATH" \
    PYTHONPATH="/app/gen:$PYTHONPATH"

# Настройка прав
RUN chown -R appuser:appuser /app

# Экспорт порта и запуск
EXPOSE ${PORT}
USER appuser
CMD ["sh", "-c", "uv sync && uv run python service_math_solve.py"]